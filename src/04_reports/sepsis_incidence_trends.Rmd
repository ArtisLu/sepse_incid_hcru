---
title: "Sepses trendi"
author: "Artis Luguzis"
date: 
output:
  html_document: default
  pdf_document: default
editor_options: 
  chunk_output_type: console
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
rm(list = ls())
```

```{r libs}
library(tidyverse)
library(gtsummary)
```


```{r data}
# hospitalization level data
load(file = "data/04_analysis_data/sepsis_hosp_characteristics.RData")
load(file = "data/04_analysis_data/sepsis_patient_characteristics.RData")

# CSP population data
load(file = file.path("taskfiles", "derived", "csp_iedz.RData"))
load(file = file.path("taskfiles", "derived", "csp_iedz_vecums_gados.RData"))
```

```{r csp_processing}
# apstrādā datus
csp_iedz <- csp_iedz %>% 
  mutate(gads = as.numeric(gads)) %>% 
  rename(dzimums = dzim) %>% 
  mutate(dzimums = ifelse(dzimums == "Sievietes", "sieviete", "vīrietis"))

csp_iedz_gadi <- csp_iedz_gadi %>% 
  mutate(gads = as.numeric(gads)) %>%
  rename(dzimums = dzim) %>% 
  mutate(dzimums = ifelse(dzimums == "Sievietes", "sieviete", "vīrietis"))

# skaits pa gadiem
iedz_skaits_pa_gadiem <- csp_iedz %>%
  filter(between(as.integer(gads), 2013, 2020)) %>%
  group_by(gads) %>%
  summarise(skaits = sum(skaits)) %>%
  ungroup()

# skaits pa gadiem un vecuma / dzimuma grupās
iedz_skaits_pa_gadiem_grupas <- csp_iedz_gadi %>%
  filter(between(as.integer(gads), 2013, 2020)) %>%
  mutate(vecums_cat = cut(vec, c(0, 20, 40, 60, 80, Inf), right = FALSE, labels = c("<20","20-39", "40-59", "60-79", "80+"))) %>% 
  group_by(gads, vecums_cat, dzimums) %>%
  summarise(skaits = sum(skaits)) %>% 
  group_by(gads) %>% 
  mutate(skaits_prop = skaits/sum(skaits)) %>% 
  ungroup()
```

```{r incidence}
# tīrā incidence
incidence <- hosp_descr %>% 
  group_by(gads) %>% 
  summarise(incidence = n()) %>% 
  left_join(iedz_skaits_pa_gadiem) %>% 
  mutate(incidence_100k = round(incidence/skaits * 10^5, 1))

# vecuma-dzimuma koriģētā (i.e., pēc iedzīvotāju sastāva 2014. gadā)
incidence_by_groups <- hosp_descr %>% 
  group_by(gads, vecums_cat, dzimums) %>% 
  summarise(incidence = n()) %>%
  ungroup() %>% 
  left_join(iedz_skaits_pa_gadiem_grupas %>% select(-skaits_prop)) %>% 
  mutate(incidence_100k = incidence/skaits * 10^5)

# pievieno 2014. gada proporcijas
incidence_adj <- incidence_by_groups %>% 
  left_join(iedz_skaits_pa_gadiem_grupas %>% filter(gads == 2014), by = c("vecums_cat", "dzimums")) %>% 
  mutate(weighted_inc = skaits_prop * incidence_100k) %>% 
  select(-gads.y) %>% 
  rename(gads = gads.x) %>% 
  group_by(gads) %>% 
  summarise(incidence_100k_adj = round(sum(weighted_inc), 1))

incidence_total <- incidence %>% 
  left_join(incidence_adj)
```

```{r cfr}
# case fatality
case_fatality <- hosp_descr %>% 
  group_by(gads) %>% 
  summarise(case_fatality = round(mean(nave), 2))

# # vecuma-dzimuma koriģētā (i.e., pēc iedzīvotāju sastāva 2014. gadā)
# case_fatality_by_groups <- hosp_descr %>% 
#   group_by(gads, vecums_cat, dzimums) %>% 
#   summarise(case_fatality = mean(nave)) %>% 
#   ungroup()
# 
# # pievieno 2014. gada proporcijas
# case_fatality_adj <- case_fatality_by_groups %>% 
#   left_join(iedz_skaits_pa_gadiem_grupas %>% filter(gads == 2014), by = c("vecums_cat", "dzimums")) %>% 
#   mutate(weighted_cfr = skaits_prop * case_fatality) %>% 
#   select(-gads.y) %>% 
#   rename(gads = gads.x) %>% 
#   group_by(gads) %>% 
#   summarise(case_fatality_adj = sum(weighted_cfr))
# 
# incidence_total <- incidence %>% 
#   left_join(incidence_adj)
```

```{r other-stats}
# pirmais sepses gadījums
pirma_sepse <- hosp_descr %>% 
  group_by(gads) %>% 
  summarise(
    first_sepsis_hosp = sum(pirma_sepse_gada)
  )

# hospitalizāciju skaits katram pacientam
sepsis_hosp_skaits <- patient_descr %>% 
  group_by(gads) %>% 
  summarise(
    median = median(n_sepsis_hosp),
    q1 = quantile(n_sepsis_hosp, 0.25),
    q3 = quantile(n_sepsis_hosp, 0.75)
  ) %>% 
  mutate(sepsis_hosp_skaits = paste0(median, " (", q1, ",", q3, ")")) %>% 
  select(gads, sepsis_hosp_skaits)

# pacienti ar atkārtotu hospitalizāciju
readmission <- patient_descr %>% 
  group_by(gads) %>% 
  summarise(readmission = round(mean(readmit_1g), 2))
```

# Incidences trendi
```{r}
incidence_trends <- incidence_total %>% 
  select(-skaits) %>% 
  left_join(case_fatality) %>% 
  left_join(pirma_sepse) %>% 
  left_join(sepsis_hosp_skaits) %>% 
  left_join(readmission)

colnames_new <- incidence$gads

incidence_trends <- incidence_trends %>% 
  t() %>% 
  as.data.frame()

colnames(incidence_trends) <- colnames_new

incidence_trends <- incidence_trends[-1, ]

incidence_trends %>% knitr::kable()
```

# Sepses hospitalizāciju raksturojums
```{r hosp_summary}
hosp_descr %>% 
  filter(gads != 2013) %>% 
  tbl_summary(by = gads)
```


